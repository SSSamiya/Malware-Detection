import os
import re
import sys
from binascii import hexlify
from Crypto.Cipher import DES3

FILE_PATH  = sys.argv[1]
config = {}

def get_string(line):
    return "".join((char for char in line if 32 < ord(char) < 127))

def decryption(data, offset):
    try:
        enc_set = []
        url_list = []
        enc_data = []
        key_data = b""
        x = 0
        for i in range(4):
            while 1:
                if data[offset + x] != 0:
                    enc_set.append(data[offset + x])
                    x += 1
                else:
                    enc_data.append(bytes(enc_set))
                    enc_set = []
                    x += 4
                    break

        offset = offset + x
        iv = data[offset : offset + 12].replace(b"\0", b"")
        print(" iv = ",hexlify(iv))
        
        offset = offset + 12
        for i in range(3)[::-1]:
            key_data += data[offset + (12 * i) : offset + (12 * (i+1))].replace(b"\0", b"")
        key = key_data
        print("key = ",hexlify(key))

        i = 0
        for data in enc_data:
            des = DES3.new(key, IV=iv, mode = DES3.MODE_CBC)
            data_dec = des.decrypt(data)
            #print("Dec Data : ", data_dec)
            url_list.append(get_string(data_dec.decode()))
            i += 1
    except Exception as e:
        print(e)
    return url_list

if __name__ == "__main__":
    try:
        data = open(FILE_PATH, 'rb').read()
        if data.find(b"ckav.ru") != -1:
            offset = data.find(b"ckav.ru") + 12
            urls = decryption(data, offset)
            #print(url)
            urls = ["http://" + s for s in urls]
            config["C2 List"] = urls
            print(config)
            
    except Exception as e:
        print(e)
